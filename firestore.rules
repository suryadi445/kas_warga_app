// Firestore security rules for kas_warga
// ------------------------------
// IMPORTANT:
// - These rules require authentication (request.auth != null) for reads.
// - Admin-only writes are gated by a custom claim `role == 'Admin'`.
// - For quick development testing you can temporarily replace the rules with the DEV block below, but DO NOT keep it in production.

// DEV TESTING (UNSAFE - use only for short local/debug tests)
// Uncomment to temporarily allow reads/writes for everybody:
// service cloud.firestore {
//   match /databases/{database}/documents {
//     match /{document=**} { allow read, write: if true; }
//   }
// }

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users: owners or admins may update/delete, creation allowed for authenticated users
    match /users/{userId} {
      allow create: if request.auth != null; // allow sign-up to create their profile
      allow read: if request.auth != null && (request.auth.uid == userId || request.auth.token.role == 'Admin');
      allow update, delete: if request.auth != null && (request.auth.uid == userId || request.auth.token.role == 'Admin');
    }

    // Cash reports (dashboard data)
    match /cash_reports/{docId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && (request.auth.uid == resource.data.ownerId || request.auth.token.role == 'Admin');
    }

    // Announcements (read for users, writes only for Admin)
    match /announcements/{docId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null && request.auth.token.role == 'Admin';
    }

    // Schedules (read for users, writes only for Admin)
    match /schedules/{docId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null && request.auth.token.role == 'Admin';
    }

    // Activities (read for users, writes only for Admin)
    match /activities/{docId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null && request.auth.token.role == 'Admin';
    }

    // Notifications (created by app/service); users may read notifications relevant to them
    match /notifications/{docId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null; // app/service can write notifications
      allow update, delete: if request.auth != null && request.auth.token.role == 'Admin';
    }

    // Devices: store push tokens for registered devices (created by authenticated clients)
    match /devices/{deviceId} {
      // Allow authenticated users to create their device token document
      allow create: if request.auth != null;
      // Allow reads only to authenticated users and restrict updates/deletes to Admin
      allow read: if request.auth != null;
      allow update, delete: if request.auth != null && request.auth.token.role == 'Admin';
    }

    // Feedbacks: users may create/read their feedbacks; Admin may read all
    match /feedbacks/{docId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null && (request.auth.token.role == 'Admin' || request.auth.uid == resource.data.ownerId || resource.data.ownerId == null);
      allow update, delete: if request.auth != null && (request.auth.uid == resource.data.ownerId || request.auth.token.role == 'Admin');
    }

    // Meta: small documents like counters or cached counts
    match /meta/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.role == 'Admin';
    }

    // Settings document (app-level settings like appName)
    match /settings/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.role == 'Admin';
    }

    // Deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}