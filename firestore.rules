// Firestore security rules for kas_warga
// ------------------------------
// IMPORTANT:
// - These rules require authentication (request.auth != null) for reads.
// - Admin-only writes are gated by checking the user's role in Firestore.
// - For quick development testing you can temporarily replace the rules with the DEV block below, but DO NOT keep it in production.

// DEV TESTING (UNSAFE - use only for short local/debug tests)
// Uncomment to temporarily allow reads/writes for everybody:
// service cloud.firestore {
//   match /databases/{database}/documents {
//     match /{document=**} { allow read, write: if true; }
//   }
// }

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function: check if the authenticated user has Admin role in Firestore
    function isAdmin() {
      return request.auth != null && 
             (
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin' ||
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
             );
    }

    // Helper function: check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Users: owners or admins may update/delete, creation allowed for authenticated users
    match /users/{userId} {
      allow create: if isAuthenticated(); // allow sign-up to create their profile
      allow read: if isAuthenticated();
      allow update, delete: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
    }

    // Cash reports (dashboard data)
    match /cash_reports/{docId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Allow update/delete if: user is owner, OR user is Admin, OR ownerId doesn't exist (backward compat)
      allow update, delete: if isAuthenticated() && (
        request.auth.uid == resource.data.ownerId || 
        isAdmin() ||
        !('ownerId' in resource.data)
      );
    }

    // Announcements (read for users, writes only for Admin)
    match /announcements/{docId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated() && isAdmin();
    }

    // Schedules (read for users, writes only for Admin)
    match /schedules/{docId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated() && isAdmin();
    }

    // Activities (read for users, writes only for Admin)
    match /activities/{docId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated() && isAdmin();
    }

    // Documentation (read for users, writes only for Admin)
    match /documentation/{docId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated() && isAdmin();
    }

    // Organization (read for users, writes only for Admin)
    match /organization/{docId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated() && isAdmin();
    }

    // Notifications (created by app/service); users may read and update (mark as read)
    match /notifications/{docId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated(); // app/service can write notifications
      allow update: if isAuthenticated(); // users can mark notifications as read
      allow delete: if isAuthenticated() && isAdmin();
    }

    // Devices: store push tokens for registered devices (created by authenticated clients)
    match /devices/{deviceId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated();
      // Allow update if authenticated (to refresh token timestamp or user association)
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated() && isAdmin();
    }

    // Feedbacks: users may create/read their feedbacks; Admin may read all
    match /feedbacks/{docId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated();
      allow update, delete: if isAuthenticated() && (request.auth.uid == resource.data.ownerId || isAdmin());
    }

    // Meta: small documents like counters or cached counts
    match /meta/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isAdmin();
    }

    // Settings document (app-level settings like appName)
    match /settings/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isAdmin();
    }

    // Broadcasts (read/create only for Admin)
    match /broadcasts/{broadcastId} {
      allow read: if isAuthenticated() && isAdmin();
      allow create: if isAuthenticated() && isAdmin();
    }
    
    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}